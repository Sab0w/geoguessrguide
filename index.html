<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GeoGuessr - Europe</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{--bg:#1a1a1a;--card:#2d2d2d;--text:#fff;--accent:#4285F4;--del:#f55}
*{box-sizing:border-box}
body{background:var(--bg);font-family:'Segoe UI',sans-serif;color:var(--text);margin:0;padding:40px;overflow-x:hidden}

/* Login styles */
.login-container{display:flex;align-items:center;justify-content:center;min-height:calc(100vh - 80px)}
.login-box{background:var(--card);padding:40px;border-radius:16px;width:100%;max-width:400px;box-shadow:0 8px 32px rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.1)}
.login-box h1{text-align:center;margin:0 0 10px;font-weight:300}
.login-box p{text-align:center;color:#888;margin:0 0 30px}
.login-box label{display:block;margin-bottom:5px;font-weight:500;color:#ccc}
.login-box input{width:100%;padding:12px;background:#1a1a1a;border:1px solid #444;color:#fff;border-radius:8px;font-size:1rem;margin-bottom:20px}
.login-box input:focus{outline:none;border-color:var(--accent)}
.login-btn{width:100%;padding:14px;background:var(--accent);color:#fff;border:none;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer;transition:all .3s}
.login-btn:hover{background:#3367d6}
.login-btn:disabled{opacity:.5;cursor:not-allowed}
.login-error{background:rgba(255,85,85,.1);border:1px solid var(--del);color:var(--del);padding:12px;border-radius:8px;margin-bottom:20px;text-align:center;display:none}
.login-tabs{display:flex;margin-bottom:25px;border-radius:8px;overflow:hidden;border:1px solid rgba(255,255,255,.1)}
.login-tab{flex:1;padding:12px;background:transparent;border:none;color:#888;cursor:pointer;font-weight:600;transition:all .3s}
.login-tab.active{background:var(--accent);color:#fff}
.login-tab:hover:not(.active){background:rgba(255,255,255,.05)}
.user-bar{display:flex;align-items:center;justify-content:flex-end;gap:15px;margin-bottom:20px;max-width:1200px;margin-left:auto;margin-right:auto}
.user-info{display:flex;align-items:center;gap:10px;color:#888;font-size:.9rem}
.user-email{color:var(--accent)}
.logout-btn{background:rgba(255,85,85,.1);color:var(--del);border:1px solid var(--del);padding:8px 16px;border-radius:6px;cursor:pointer;font-size:.85rem;font-weight:600;transition:all .3s}
.logout-btn:hover{background:var(--del);color:#fff}
.header{max-width:1200px;margin:0 auto 30px;display:flex;align-items:center;justify-content:center;gap:20px}
.title-wrapper{display:flex;align-items:center;justify-content:center;gap:15px}
h1{font-weight:300;margin:0}
.action-bar{max-width:1200px;margin:0 auto 30px;display:flex;justify-content:space-between}
.btn{padding:12px 24px;border:none;border-radius:6px;font-size:1rem;font-weight:bold;cursor:pointer;transition:all .3s}
.btn-primary{background:var(--accent);color:#fff}
.btn-primary:hover{background:#3367d6}
.btn-secondary{background:#6b7280;color:#fff}
.btn-secondary:hover{background:#4b5563}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:25px;max-width:1200px;margin:0 auto}
.card{background:var(--card);border-radius:16px;overflow:hidden;box-shadow:0 4px 15px rgba(0,0,0,.3);transition:transform .3s;border:1px solid rgba(255,255,255,.05);position:relative;cursor:pointer}
.card:hover{transform:translateY(-5px);box-shadow:0 15px 30px rgba(0,0,0,.5);border-color:var(--accent)}
.card-actions{position:absolute;top:10px;right:10px;display:flex;gap:8px;z-index:10;opacity:0;transition:opacity .3s}
.card:hover .card-actions{opacity:1}
.btn-icon{background:rgba(0,0,0,.7);border:none;border-radius:50%;width:32px;height:32px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .3s}
.btn-edit{color:var(--accent)}
.btn-edit:hover{background:var(--accent);color:#fff;transform:scale(1.1)}
.btn-del{color:var(--del)}
.btn-del:hover{background:var(--del);color:#fff;transform:scale(1.1)}
.flag{height:140px;background-size:cover;background-position:center;position:relative}
.flag::after{content:'';position:absolute;bottom:0;left:0;right:0;height:60%;background:linear-gradient(to top,rgba(0,0,0,.9),transparent)}
.country-name{position:relative;z-index:2;font-size:1.5rem;font-weight:700;padding:15px;height:140px;display:flex;align-items:flex-end;text-shadow:0 2px 4px rgba(0,0,0,.8)}
.content{padding:20px}
.row{display:flex;align-items:center;margin-bottom:12px;font-size:.95rem}
.tag{font-size:.7rem;padding:3px 8px;border-radius:4px;font-weight:bold;text-transform:uppercase;margin-right:10px;min-width:60px;text-align:center}
.modal{display:none;position:fixed;z-index:100;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.8);overflow-y:auto}
.modal.show{display:flex;align-items:center;justify-content:center;padding:20px}
.modal-content{background:var(--card);padding:30px;border-radius:12px;width:90%;max-width:800px;border:1px solid #444;max-height:90vh;overflow-y:auto}
.close{color:#aaa;float:right;font-size:28px;font-weight:bold;cursor:pointer}
.close:hover{color:#fff}
label{display:block;margin-top:15px;margin-bottom:5px;font-weight:500}
input,textarea{width:100%;padding:10px;background:#1a1a1a;border:1px solid #444;color:#fff;border-radius:6px;font-family:inherit}
input[type="color"]{width:50px;height:36px;padding:2px;cursor:pointer;border-radius:6px}
textarea{resize:vertical;min-height:80px}
.divider{border-top:1px solid #444;margin:25px 0;padding-top:20px}
.section{background:rgba(139,92,246,.1);border:1px solid rgba(139,92,246,.3);border-radius:8px;padding:15px;margin-bottom:15px;position:relative}
.section-row{display:flex;gap:10px;align-items:flex-end}
.section-row .field{flex:1}
.section-row .field-color{flex:0 0 auto}
.section-photo-preview{margin-top:10px}
.section-photo-preview img{max-width:100%;max-height:150px;border-radius:8px;border:1px solid rgba(255,255,255,.2)}
.subcat-section{background:rgba(66,133,244,.1);border:1px solid rgba(66,133,244,.3);border-radius:12px;padding:20px;margin-bottom:20px;cursor:grab;transition:all .2s;position:relative}
.subcat-section:active{cursor:grabbing}
.subcat-section.dragging{opacity:0.4;transform:scale(0.98);box-shadow:0 8px 24px rgba(0,0,0,.4)}
.drag-indicator{height:4px;background:var(--accent);border-radius:2px;margin:10px 0;transition:all .2s;box-shadow:0 0 10px var(--accent)}
.drag-ghost{position:fixed;pointer-events:none;z-index:1000;opacity:0.9;transform:rotate(2deg);box-shadow:0 12px 40px rgba(0,0,0,.5);background:rgba(66,133,244,.2);border:2px solid var(--accent);border-radius:12px;padding:15px 20px;color:#fff;font-weight:600;max-width:300px}
#subcatContainer{min-height:50px}
.subcat-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
.subcat-name{font-size:1.2rem;font-weight:600;color:var(--accent)}
.gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:15px;margin-top:15px}
.photo{background:rgba(0,0,0,.3);border-radius:8px;overflow:hidden;border:1px solid rgba(255,255,255,.1);position:relative;cursor:pointer;transition:transform .2s}
.photo:hover{transform:scale(1.03)}
.photo img{width:100%;height:120px;object-fit:cover}
.photo-title{padding:10px;font-size:.85rem;color:#ccc}
.photo-del{position:absolute;top:5px;right:5px;background:rgba(255,85,85,.9);color:#fff;border:none;border-radius:4px;width:24px;height:24px;cursor:pointer;opacity:0;transition:opacity .3s;font-size:14px;line-height:1;z-index:5}
.photo:hover .photo-del{opacity:1}
.add-photo{background:rgba(66,133,244,.1);border:2px dashed var(--accent);border-radius:8px;height:120px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--accent);font-weight:600}
.add-photo:hover{background:rgba(66,133,244,.2)}
.btn-add-section{background:rgba(139,92,246,.2);color:#a78bfa;border:1px dashed #a78bfa;padding:10px;width:100%;border-radius:6px;cursor:pointer;font-weight:600;margin-top:15px}
.btn-add-section:hover{background:rgba(139,92,246,.3)}
.btn-remove{position:absolute;top:10px;right:10px;background:rgba(255,85,85,.2);color:var(--del);border:1px solid var(--del);border-radius:4px;padding:4px 8px;cursor:pointer;font-size:.8rem;font-weight:bold}
.btn-remove:hover{background:var(--del);color:#fff}
.save-btn{background:var(--accent);color:#fff;padding:12px;border:none;width:100%;border-radius:6px;cursor:pointer;font-size:1rem;font-weight:bold;margin-top:20px}
.save-btn:hover{background:#3367d6}
.save-btn:disabled{opacity:.5;cursor:not-allowed}
.detail-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;padding-bottom:20px;border-bottom:2px solid #444}
.detail-title{font-size:2rem;font-weight:700}
.info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px}
.info-item{background:rgba(255,255,255,.05);padding:15px;border-radius:8px;border:1px solid rgba(255,255,255,.1)}
.info-label{font-size:.85rem;margin-bottom:5px;text-transform:uppercase}
.info-photo{margin-top:10px;cursor:pointer;transition:transform .2s}
.info-photo:hover{transform:scale(1.02)}
.info-photo img{width:100%;max-height:150px;object-fit:cover;border-radius:8px}
.info-photo-desc{font-size:.8rem;color:#aaa;margin-top:5px;font-style:italic}
.main-view,.detail-view-page{transition:transform .4s ease,opacity .4s ease}
.main-view{transform:translateX(0);opacity:1}
.main-view.hidden{transform:translateX(-100%);opacity:0;pointer-events:none;position:absolute;width:100%}
.detail-view-page{position:fixed;top:0;left:0;right:0;bottom:0;background:var(--bg);transform:translateX(100%);opacity:0;pointer-events:none;overflow-y:auto;padding:40px;z-index:50}
.detail-view-page.active{transform:translateX(0);opacity:1;pointer-events:auto}
.detail-container{max-width:1200px;margin:0 auto}
.detail-nav{display:flex;justify-content:space-between;align-items:center;margin-bottom:40px;padding-bottom:20px;border-bottom:2px solid #444}
.detail-nav-left{display:flex;align-items:center;gap:20px}
.detail-nav h1{margin:0;font-size:2.5rem;font-weight:700}
.detail-nav-actions{display:flex;gap:10px}
.country-flag-large{width:80px;height:60px;border-radius:8px;object-fit:cover;box-shadow:0 4px 8px rgba(0,0,0,.3)}
.section-title{color:var(--accent);font-size:1.5rem;margin:40px 0 20px;font-weight:600}
.edit-inline-btn{background:rgba(66,133,244,.2);color:var(--accent);border:1px solid var(--accent);padding:6px 12px;border-radius:6px;cursor:pointer;font-size:.85rem;font-weight:600;transition:all .3s}
.edit-inline-btn:hover{background:var(--accent);color:#fff}
.continent-selector{position:relative;display:inline-block}
.continent-button{background:var(--card);color:#fff;padding:12px 24px;border:1px solid rgba(255,255,255,.2);border-radius:8px;font-size:1.5rem;font-weight:300;cursor:pointer;display:flex;align-items:center;gap:10px;transition:all .3s}
.continent-button:hover{background:rgba(66,133,244,.2);border-color:var(--accent)}
.continent-button::after{content:'‚ñº';font-size:.8rem;transition:transform .3s}
.continent-button.open::after{transform:rotate(180deg)}
.continent-dropdown{position:absolute;top:calc(100% + 10px);left:50%;transform:translateX(-50%);background:var(--card);border:1px solid rgba(255,255,255,.2);border-radius:8px;min-width:250px;box-shadow:0 8px 24px rgba(0,0,0,.5);opacity:0;visibility:hidden;transition:all .3s;z-index:1000;max-height:400px;overflow-y:auto}
.continent-dropdown.show{opacity:1;visibility:visible}
.continent-item{padding:12px 20px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:12px;border-bottom:1px solid rgba(255,255,255,.05)}
.continent-item:last-child{border-bottom:none}
.continent-item:hover{background:rgba(66,133,244,.2);padding-left:25px}
.continent-item.active{background:rgba(66,133,244,.3);border-left:3px solid var(--accent);font-weight:600}
.continent-emoji{font-size:1.5rem}
.continent-name{flex:1}
.continent-divider{height:1px;background:rgba(255,255,255,.1);margin:8px 0}
.add-continent-btn{color:var(--accent);font-weight:600}
.add-continent-btn:hover{background:rgba(66,133,244,.3)}

/* Lightbox styles */
.lightbox{display:none;position:fixed;z-index:200;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.95);align-items:center;justify-content:center;cursor:zoom-out}
.lightbox.show{display:flex}
.lightbox img{max-width:90%;max-height:90%;object-fit:contain;border-radius:8px;box-shadow:0 8px 32px rgba(0,0,0,.5)}
.lightbox-close{position:absolute;top:20px;right:30px;color:#fff;font-size:40px;font-weight:bold;cursor:pointer;transition:color .3s;z-index:201}
.lightbox-close:hover{color:var(--accent)}
.lightbox-title{position:absolute;bottom:30px;left:50%;transform:translateX(-50%);color:#fff;font-size:1.2rem;text-align:center;background:rgba(0,0,0,.7);padding:10px 20px;border-radius:8px;max-width:80%}

/* Color presets */
.color-presets{display:flex;gap:6px;margin-top:5px;flex-wrap:wrap}
.color-preset{width:24px;height:24px;border-radius:4px;cursor:pointer;border:2px solid transparent;transition:all .2s}
.color-preset:hover{transform:scale(1.1);border-color:#fff}

/* Emoji presets */
.emoji-presets{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
.emoji-preset{font-size:1.5rem;cursor:pointer;padding:5px;border-radius:6px;transition:all .2s}
.emoji-preset:hover{background:rgba(66,133,244,.3);transform:scale(1.2)}

/* Bouton supprimer cat√©gorie */
.btn-del-continent{background:rgba(255,85,85,.2);color:var(--del);border:none;border-radius:4px;width:24px;height:24px;cursor:pointer;font-size:14px;opacity:0;transition:opacity .3s;margin-left:auto}
.continent-item:hover .btn-del-continent{opacity:1}
.btn-del-continent:hover{background:var(--del);color:#fff}

/* Logo type selector */
.logo-type-selector{display:flex;gap:10px;margin:10px 0}
.logo-type-btn{flex:1;padding:10px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.2);color:#fff;border-radius:6px;cursor:pointer;font-size:.9rem;transition:all .3s}
.logo-type-btn:hover{background:rgba(66,133,244,.2);border-color:var(--accent)}
.logo-type-btn.active{background:rgba(66,133,244,.3);border-color:var(--accent);color:var(--accent);font-weight:600}
.logo-preview{margin-top:10px;text-align:center}
.logo-preview img{max-width:80px;max-height:80px;border-radius:8px;border:2px solid rgba(255,255,255,.2)}
.continent-logo{width:30px;height:30px;border-radius:6px;object-fit:cover}
</style>
</head>
<body>

<!-- √âcran de connexion -->
<div id="loginView" class="login-container">
<div class="login-box">
<h1>üåç GeoGuessr</h1>
<p>Connectez-vous pour acc√©der √† votre base</p>
<div class="login-tabs">
<button class="login-tab active" id="tabLogin">Connexion</button>
<button class="login-tab" id="tabRegister">Inscription</button>
</div>
<div class="login-error" id="loginError"></div>
<form id="loginForm">
<label>Email</label>
<input type="email" id="loginEmail" placeholder="votre@email.com" required>
<label>Mot de passe</label>
<input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
<button type="submit" class="login-btn" id="loginBtn">Se connecter</button>
</form>
</div>
</div>

<!-- Application principale (cach√©e par d√©faut) -->
<div id="appView" style="display:none">
<div class="user-bar">
<div class="user-info">
<span>Connect√© en tant que</span>
<span class="user-email" id="userEmail"></span>
</div>
<button class="logout-btn" id="logoutBtn">D√©connexion</button>
</div>
<div class="main-view" id="mainView">
<div class="header">
<div class="title-wrapper">
<div class="continent-selector">
<button class="continent-button" id="continentButton">
<span id="currentContinentName">Europe</span>
</button>
<div class="continent-dropdown" id="continentDropdown">
<div class="continent-item" data-continent="europe">
<span class="continent-emoji">üè∞</span>
<span class="continent-name">Europe</span>
</div>
<div class="continent-item" data-continent="asia">
<span class="continent-emoji">üèØ</span>
<span class="continent-name">Asie</span>
</div>
<div class="continent-item" data-continent="africa">
<span class="continent-emoji">ü¶Å</span>
<span class="continent-name">Afrique</span>
</div>
<div class="continent-item" data-continent="north-america">
<span class="continent-emoji">üóΩ</span>
<span class="continent-name">Am√©rique du Nord</span>
</div>
<div class="continent-item" data-continent="south-america">
<span class="continent-emoji">üå¥</span>
<span class="continent-name">Am√©rique du Sud</span>
</div>
<div class="continent-item" data-continent="oceania">
<span class="continent-emoji">ü¶ò</span>
<span class="continent-name">Oc√©anie</span>
</div>
<div class="continent-item" data-continent="antarctica">
<span class="continent-emoji">üêß</span>
<span class="continent-name">Antarctique</span>
</div>
<div class="continent-divider"></div>
<div class="continent-item add-continent-btn" id="addContinentBtn">
<span class="continent-emoji">‚ûï</span>
<span class="continent-name">Ajouter une cat√©gorie</span>
</div>
</div>
</div>
</div>
</div>
<div class="action-bar">
<button class="btn btn-secondary" id="refreshBtn">üîÑ Actualiser</button>
<button class="btn btn-primary" id="addCountryBtn">‚ûï Ajouter un pays</button>
</div>
<div class="grid" id="grid"></div>
</div>

<div class="detail-view-page" id="detailViewPage">
<div class="detail-container" id="detailPageContent"></div>
</div>

<!-- Lightbox pour agrandir les photos -->
<div class="lightbox" id="lightbox">
<span class="lightbox-close" id="lightboxClose">&times;</span>
<img src="" alt="" id="lightboxImg">
<div class="lightbox-title" id="lightboxTitle"></div>
</div>

<div id="countryModal" class="modal">
<div class="modal-content">
<span class="close" id="closeCountryBtn">&times;</span>
<h2 id="countryModalTitle">Ajouter un Pays</h2>
<label>Nom *</label>
<input type="text" id="inputName" placeholder="France">
<label>Drapeau (URL)</label>
<input type="text" id="inputFlag" placeholder="https://...">
<div class="divider">
<h3>Cat√©gories</h3>
<div id="sectionsContainer"></div>
<button class="btn-add-section" id="addSectionBtn">+ Cat√©gorie</button>
</div>
<label>Lien (optionnel)</label>
<input type="text" id="inputLink" placeholder="#">
<button class="save-btn" id="saveCountryBtn">Sauvegarder</button>
</div>
</div>

<div id="detailModal" class="modal">
<div class="modal-content" id="detailContent"></div>
</div>

<div id="subcatModal" class="modal">
<div class="modal-content">
<span class="close" id="closeSubcatBtn">&times;</span>
<h2 id="subcatModalTitle">Sous-cat√©gorie</h2>
<label>Nom *</label>
<input type="text" id="inputSubcatName" placeholder="Architecture">
<div class="divider">
<h3>Photos</h3>
<div id="photosContainer"></div>
<button class="btn-add-section" id="addPhotoBtn">+ Photo</button>
</div>
<button class="save-btn" id="saveSubcatBtn">Sauvegarder</button>
</div>
</div>

<div id="continentModal" class="modal">
<div class="modal-content">
<span class="close" id="closeContinentBtn">&times;</span>
<h2>Ajouter une cat√©gorie</h2>
<label>Nom *</label>
<input type="text" id="inputContinentName" placeholder="Moyen-Orient">
<label>Type de logo</label>
<div class="logo-type-selector">
<button type="button" class="logo-type-btn active" data-type="emoji" id="logoTypeEmoji">üòÄ Emoji</button>
<button type="button" class="logo-type-btn" data-type="image" id="logoTypeImage">üñºÔ∏è Image URL</button>
</div>
<div id="logoEmojiSection">
<label>Emoji</label>
<input type="text" id="inputContinentEmoji" placeholder="üïå" maxlength="2">
<div class="emoji-presets">
<span class="emoji-preset" data-emoji="üèîÔ∏è">üèîÔ∏è</span>
<span class="emoji-preset" data-emoji="üèùÔ∏è">üèùÔ∏è</span>
<span class="emoji-preset" data-emoji="üïå">üïå</span>
<span class="emoji-preset" data-emoji="üóø">üóø</span>
<span class="emoji-preset" data-emoji="‚õ©Ô∏è">‚õ©Ô∏è</span>
<span class="emoji-preset" data-emoji="üåã">üåã</span>
<span class="emoji-preset" data-emoji="üèúÔ∏è">üèúÔ∏è</span>
<span class="emoji-preset" data-emoji="üåä">üåä</span>
<span class="emoji-preset" data-emoji="üó∫Ô∏è">üó∫Ô∏è</span>
<span class="emoji-preset" data-emoji="üåê">üåê</span>
</div>
</div>
<div id="logoImageSection" style="display:none">
<label>URL de l'image</label>
<input type="text" id="inputContinentLogo" placeholder="https://exemple.com/logo.png">
<div id="logoPreview" class="logo-preview"></div>
</div>
<button class="save-btn" id="saveContinentBtn">Ajouter</button>
</div>
</div>

</div><!-- Fin appView -->

<script>
(function(){
const SUPABASE_URL='https://iawoksstpmtppadktnmi.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlhd29rc3N0cG10cHBhZGt0bm1pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MzUwOTAsImV4cCI6MjA4NDAxMTA5MH0.vl2Grce9qtU97lDKILYJughIfFpzY1TV-ELdmJkDaKg';
let CONTINENT='europe';
let supabase,sections=[],currentCountry=null,editSubcatIdx=null,photos=[];
let customContinents=[];
let currentUser=null;
let isLoginMode=true;

// Couleurs pr√©d√©finies pour les cat√©gories
const colorPresets=[
'#2ecc71','#e67e22','#9b59b6','#3498db','#e74c3c','#1abc9c','#f39c12','#e91e63','#00bcd4','#8bc34a'
];

const baseContinentNames={
'europe':'Europe',
'asia':'Asie',
'africa':'Afrique',
'north-america':'Am√©rique du Nord',
'south-america':'Am√©rique du Sud',
'oceania':'Oc√©anie',
'antarctica':'Antarctique'
};

function getContinentNames(){
const names={...baseContinentNames};
customContinents.forEach(c=>{
names[c.id]=c.name;
});
return names;
}

function hexToRgba(hex,alpha){
const r=parseInt(hex.slice(1,3),16);
const g=parseInt(hex.slice(3,5),16);
const b=parseInt(hex.slice(5,7),16);
return `rgba(${r},${g},${b},${alpha})`;
}

function init(){
if(!window.supabase){setTimeout(init,100);return;}
supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
setupAuthEvents();
checkAuth();
}

function setupAuthEvents(){
// Tabs login/register
document.getElementById('tabLogin').onclick=function(){
isLoginMode=true;
this.classList.add('active');
document.getElementById('tabRegister').classList.remove('active');
document.getElementById('loginBtn').textContent='Se connecter';
};
document.getElementById('tabRegister').onclick=function(){
isLoginMode=false;
this.classList.add('active');
document.getElementById('tabLogin').classList.remove('active');
document.getElementById('loginBtn').textContent="S'inscrire";
};

// Form submit
document.getElementById('loginForm').onsubmit=async function(e){
e.preventDefault();
const email=document.getElementById('loginEmail').value.trim();
const password=document.getElementById('loginPassword').value;
const btn=document.getElementById('loginBtn');
const errorDiv=document.getElementById('loginError');

btn.disabled=true;
btn.textContent=isLoginMode?'Connexion...':'Inscription...';
errorDiv.style.display='none';

try{
let result;
if(isLoginMode){
result=await supabase.auth.signInWithPassword({email,password});
}else{
result=await supabase.auth.signUp({email,password});
if(result.data?.user&&!result.error){
errorDiv.style.display='block';
errorDiv.style.background='rgba(46,204,113,.1)';
errorDiv.style.borderColor='#2ecc71';
errorDiv.style.color='#2ecc71';
errorDiv.textContent='Inscription r√©ussie ! V√©rifiez votre email pour confirmer votre compte.';
btn.disabled=false;
btn.textContent="S'inscrire";
return;
}
}
if(result.error)throw result.error;
}catch(err){
errorDiv.style.display='block';
errorDiv.style.background='rgba(255,85,85,.1)';
errorDiv.style.borderColor='var(--del)';
errorDiv.style.color='var(--del)';
errorDiv.textContent=err.message==='Invalid login credentials'?'Email ou mot de passe incorrect':err.message;
btn.disabled=false;
btn.textContent=isLoginMode?'Se connecter':"S'inscrire";
}
};

// Logout
document.getElementById('logoutBtn').onclick=async function(){
await supabase.auth.signOut();
showLogin();
};

// √âcouter les changements d'√©tat d'auth
supabase.auth.onAuthStateChange((event,session)=>{
if(event==='SIGNED_IN'&&session){
currentUser=session.user;
showApp();
}else if(event==='SIGNED_OUT'){
currentUser=null;
showLogin();
}
});
}

async function checkAuth(){
const {data:{session}}=await supabase.auth.getSession();
if(session){
currentUser=session.user;
showApp();
}else{
showLogin();
}
}

function showLogin(){
document.getElementById('loginView').style.display='flex';
document.getElementById('appView').style.display='none';
document.getElementById('loginEmail').value='';
document.getElementById('loginPassword').value='';
document.getElementById('loginError').style.display='none';
}

function showApp(){
document.getElementById('loginView').style.display='none';
document.getElementById('appView').style.display='block';
document.getElementById('userEmail').textContent=currentUser?.email||'';
initApp();
}

function initApp(){
loadCustomContinents().then(()=>{
renderCustomContinents();
loadCountries();
});
setupEvents();
setupLightbox();
}

async function loadCustomContinents(){
try{
const {data,error}=await supabase.from('custom_continents').select('*').order('name',{ascending:true});
if(error)throw error;
customContinents=data||[];
}catch(e){
console.error('Erreur chargement cat√©gories:',e);
customContinents=[];
}
}

function setupLightbox(){
const lightbox=document.getElementById('lightbox');
const lightboxClose=document.getElementById('lightboxClose');
lightboxClose.onclick=closeLightbox;
lightbox.onclick=function(e){
if(e.target===lightbox)closeLightbox();
};
document.addEventListener('keydown',function(e){
if(e.key==='Escape')closeLightbox();
});
}

function openLightbox(url,title){
const lightbox=document.getElementById('lightbox');
const img=document.getElementById('lightboxImg');
const titleEl=document.getElementById('lightboxTitle');
img.src=url;
titleEl.textContent=title||'';
titleEl.style.display=title?'block':'none';
lightbox.classList.add('show');
document.body.style.overflow='hidden';
}

function closeLightbox(){
const lightbox=document.getElementById('lightbox');
lightbox.classList.remove('show');
document.body.style.overflow='';
}

function setupEvents(){
document.getElementById('refreshBtn').onclick=loadCountries;
document.getElementById('addCountryBtn').onclick=openAddCountry;
document.getElementById('closeCountryBtn').onclick=closeCountryModal;
document.getElementById('saveCountryBtn').onclick=saveCountry;
document.getElementById('addSectionBtn').onclick=addSection;
document.getElementById('closeSubcatBtn').onclick=closeSubcatModal;
document.getElementById('saveSubcatBtn').onclick=saveSubcat;
document.getElementById('addPhotoBtn').onclick=addPhoto;

// √âv√©nements pour le modal cat√©gorie
document.getElementById('addContinentBtn').onclick=function(e){
e.stopPropagation();
openAddContinent();
};
document.getElementById('closeContinentBtn').onclick=closeContinentModal;
document.getElementById('saveContinentBtn').onclick=saveContinent;
document.querySelectorAll('.emoji-preset').forEach(preset=>{
preset.onclick=function(){
document.getElementById('inputContinentEmoji').value=this.dataset.emoji;
};
});

// S√©lecteur type de logo
document.getElementById('logoTypeEmoji').onclick=function(){
document.getElementById('logoTypeEmoji').classList.add('active');
document.getElementById('logoTypeImage').classList.remove('active');
document.getElementById('logoEmojiSection').style.display='block';
document.getElementById('logoImageSection').style.display='none';
};
document.getElementById('logoTypeImage').onclick=function(){
document.getElementById('logoTypeImage').classList.add('active');
document.getElementById('logoTypeEmoji').classList.remove('active');
document.getElementById('logoImageSection').style.display='block';
document.getElementById('logoEmojiSection').style.display='none';
};
document.getElementById('inputContinentLogo').addEventListener('input',function(){
const preview=document.getElementById('logoPreview');
if(this.value.trim()){
preview.innerHTML=`<img src="${this.value}" onerror="this.style.display='none'" onload="this.style.display='block'">`;
}else{
preview.innerHTML='';
}
});

const continentBtn=document.getElementById('continentButton');
const dropdown=document.getElementById('continentDropdown');
continentBtn.onclick=function(e){
e.stopPropagation();
continentBtn.classList.toggle('open');
dropdown.classList.toggle('show');
};

document.addEventListener('click',function(e){
if(!e.target.closest('.continent-selector')){
continentBtn.classList.remove('open');
dropdown.classList.remove('show');
}
});

document.querySelectorAll('.continent-item:not(.add-continent-btn)').forEach(item=>{
item.onclick=function(){
const newContinent=this.dataset.continent;
if(newContinent&&newContinent!==CONTINENT){
switchContinent(newContinent);
}
continentBtn.classList.remove('open');
dropdown.classList.remove('show');
};
});

updateContinentUI();
}

async function loadCountries(){
const g=document.getElementById('grid');
g.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:60px;color:#888">‚è≥ Chargement...</div>';
try{
const {data,error}=await supabase.from('countries').select('*').eq('continent',CONTINENT).order('name',{ascending:true});
if(error)throw error;
renderCountries(data||[]);
}catch(e){
console.error(e);
g.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:60px;color:#888">‚ùå Erreur de chargement</div>';
}
}

function switchContinent(continent){
CONTINENT=continent;
updateContinentUI();
if(document.getElementById('detailViewPage').classList.contains('active')){
closeDetailPage();
}
loadCountries();
}

function updateContinentUI(){
const continentNames=getContinentNames();
document.getElementById('currentContinentName').textContent=continentNames[CONTINENT]||CONTINENT;
document.querySelectorAll('.continent-item[data-continent]').forEach(item=>{
if(item.dataset.continent===CONTINENT){
item.classList.add('active');
}else{
item.classList.remove('active');
}
});
}

function renderCountries(cs){
const g=document.getElementById('grid');
g.innerHTML='';
if(!cs.length){
g.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:60px;color:#888">Aucun pays</div>';
return;
}
cs.forEach(c=>{
const d=document.createElement('div');
d.className='card';
let html=`<div class="card-actions">
<button class="btn-icon btn-edit">‚úèÔ∏è</button>
<button class="btn-icon btn-del">√ó</button>
</div>
<div class="flag" style="background-image:url('${c.flag||'https://via.placeholder.com/300x150'}')">
<div class="country-name">${c.name}</div>
</div>
<div class="content">`;
if(c.custom_sections&&c.custom_sections.length){
c.custom_sections.forEach(s=>{
const color=s.color||'#a78bfa';
html+=`<div class="row"><span class="tag" style="background:${hexToRgba(color,0.2)};color:${color};border:1px solid ${color}">${s.name}</span><span>${s.value||'-'}</span></div>`;
});
}
if(c.subcategories&&c.subcategories.length){
html+=`<div class="row"><span class="tag" style="background:rgba(139,92,246,.2);color:#a78bfa;border:1px solid #a78bfa">D√©tails</span><span>${c.subcategories.length} sous-cat.</span></div>`;
}
if((!c.custom_sections||!c.custom_sections.length)&&(!c.subcategories||!c.subcategories.length)){
html+=`<div style="color:#888;font-size:.9rem">Aucune cat√©gorie</div>`;
}
html+=`</div>`;
d.innerHTML=html;
d.querySelector('.btn-edit').onclick=function(e){e.stopPropagation();editCountry(c);};
d.querySelector('.btn-del').onclick=function(e){e.stopPropagation();deleteCountry(c);};
d.onclick=()=>showDetail(c);
g.appendChild(d);
});
}

function showDetail(c){
currentCountry=c;
const page=document.getElementById('detailViewPage');
const content=document.getElementById('detailPageContent');
let h=`<div class="detail-nav">
<div class="detail-nav-left">
<button class="btn btn-secondary" id="backToListBtn">‚Üê Retour √† la liste</button>
${c.flag?`<img src="${c.flag}" class="country-flag-large" alt="${c.name}">`:''}
<h1>${c.name}</h1>
</div>
<div class="detail-nav-actions">
<button class="btn btn-secondary" id="editCountryInlineBtn">‚úèÔ∏è Modifier le pays</button>
<button class="btn btn-primary" id="addSubcatInlineBtn">+ Sous-cat√©gorie</button>
</div>
</div>`;

if(c.custom_sections&&c.custom_sections.length){
h+=`<h2 class="section-title">Informations g√©n√©rales</h2>
<div class="info-grid">`;
c.custom_sections.forEach(s=>{
const color=s.color||'#a78bfa';
h+=`<div class="info-item">
<div class="info-label" style="color:${color}">${s.name}</div>
<div>${s.value||'-'}</div>
${s.photo?`<div class="info-photo" data-url="${s.photo}" data-title="${s.photoDesc||''}">
<img src="${s.photo}" alt="${s.photoDesc||'Photo'}">
${s.photoDesc?`<div class="info-photo-desc">${s.photoDesc}</div>`:''}
</div>`:''}
</div>`;
});
h+=`</div>`;
}

if(c.subcategories&&c.subcategories.length){
h+=`<h2 class="section-title">Sous-cat√©gories (${c.subcategories.length})</h2>
<div id="subcatContainer">`;
c.subcategories.forEach((s,i)=>{
h+=`<div class="subcat-section" draggable="true" data-index="${i}">
<div class="subcat-header">
<div class="subcat-name">‚ãÆ‚ãÆ ${s.name}</div>
<div style="display:flex;gap:8px">
<button class="edit-inline-btn edit-subcat-btn" data-index="${i}">‚úèÔ∏è Modifier</button>
<button class="btn btn-secondary del-subcat-btn" data-index="${i}" style="padding:8px 12px;font-size:.85rem;background:var(--del)">üóëÔ∏è Supprimer</button>
</div>
</div>`;
if(s.photos&&s.photos.length){
h+=`<div class="gallery">`;
s.photos.forEach((p,j)=>{
h+=`<div class="photo" data-url="${p.url}" data-title="${p.title||''}">
<button class="photo-del del-photo-btn" data-subcat="${i}" data-photo="${j}">√ó</button>
<img src="${p.url}" alt="${p.title||'Photo'}">
<div class="photo-title">${p.title||''}</div>
</div>`;
});
h+=`</div>`;
}else{
h+=`<div style="color:#888;padding:10px">Aucune photo</div>`;
}
h+=`</div>`;
});
h+=`</div>`;
}else{
h+=`<div style="text-align:center;padding:60px;color:#888">
<p style="font-size:1.2rem;margin-bottom:20px">Aucune sous-cat√©gorie pour le moment</p>
<button class="btn btn-primary" id="addFirstSubcatBtn">+ Cr√©er la premi√®re sous-cat√©gorie</button>
</div>`;
}
content.innerHTML=h;
document.getElementById('backToListBtn').onclick=closeDetailPage;
document.getElementById('editCountryInlineBtn').onclick=()=>editCountry(c);
const addSubcatBtn=document.getElementById('addSubcatInlineBtn');
if(addSubcatBtn)addSubcatBtn.onclick=openAddSubcat;
const addFirstBtn=document.getElementById('addFirstSubcatBtn');
if(addFirstBtn)addFirstBtn.onclick=openAddSubcat;
document.querySelectorAll('.edit-subcat-btn').forEach(btn=>{
btn.onclick=()=>editSubcat(parseInt(btn.dataset.index));
});
document.querySelectorAll('.del-subcat-btn').forEach(btn=>{
btn.onclick=()=>deleteSubcat(parseInt(btn.dataset.index));
});
document.querySelectorAll('.del-photo-btn').forEach(btn=>{
btn.onclick=function(e){
e.stopPropagation();
deletePhoto(parseInt(btn.dataset.subcat),parseInt(btn.dataset.photo));
};
});
document.querySelectorAll('.photo').forEach(photo=>{
photo.onclick=function(e){
if(e.target.classList.contains('photo-del'))return;
const url=this.dataset.url;
const title=this.dataset.title;
openLightbox(url,title);
};
});
document.querySelectorAll('.info-photo').forEach(photo=>{
photo.onclick=function(){
const url=this.dataset.url;
const title=this.dataset.title;
openLightbox(url,title);
};
});
// Drag & Drop pour r√©organiser les sous-cat√©gories
setupSubcatDragDrop();
document.getElementById('mainView').classList.add('hidden');
page.classList.add('active');
}

function setupSubcatDragDrop(){
const container=document.getElementById('subcatContainer');
if(!container)return;

let draggedItem=null;
let draggedIndex=null;
let indicator=null;
let ghost=null;

// Cr√©er l'indicateur de position
indicator=document.createElement('div');
indicator.className='drag-indicator';
indicator.style.display='none';

container.addEventListener('dragstart',function(e){
if(!e.target.classList.contains('subcat-section'))return;
draggedItem=e.target;
draggedIndex=parseInt(e.target.dataset.index);
draggedItem.classList.add('dragging');

// Cr√©er le ghost personnalis√©
ghost=document.createElement('div');
ghost.className='drag-ghost';
ghost.textContent=currentCountry.subcategories[draggedIndex].name;
document.body.appendChild(ghost);

// Cacher le ghost par d√©faut du navigateur
const emptyImg=new Image();
emptyImg.src='data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
e.dataTransfer.setDragImage(emptyImg,0,0);
e.dataTransfer.effectAllowed='move';
});

document.addEventListener('drag',function(e){
if(ghost&&e.clientX&&e.clientY){
ghost.style.left=(e.clientX+15)+'px';
ghost.style.top=(e.clientY+15)+'px';
}
});

container.addEventListener('dragover',function(e){
e.preventDefault();
e.dataTransfer.dropEffect='move';
if(!draggedItem)return;

const afterElement=getDragAfterElement(container,e.clientY);

// Retirer l'indicateur de sa position actuelle
if(indicator.parentNode){
indicator.parentNode.removeChild(indicator);
}

indicator.style.display='block';

if(afterElement==null){
container.appendChild(indicator);
}else{
container.insertBefore(indicator,afterElement);
}
});

container.addEventListener('dragleave',function(e){
if(e.target===container&&!container.contains(e.relatedTarget)){
indicator.style.display='none';
}
});

container.addEventListener('dragend',function(){
if(draggedItem){
draggedItem.classList.remove('dragging');
}
if(indicator&&indicator.parentNode){
indicator.parentNode.removeChild(indicator);
}
if(ghost&&ghost.parentNode){
ghost.parentNode.removeChild(ghost);
}
draggedItem=null;
draggedIndex=null;
ghost=null;
});

container.addEventListener('drop',async function(e){
e.preventDefault();
if(!draggedItem||draggedIndex===null)return;

const afterElement=getDragAfterElement(container,e.clientY);
let targetIndex;

if(afterElement==null){
targetIndex=currentCountry.subcategories.length-1;
}else{
targetIndex=parseInt(afterElement.dataset.index);
if(targetIndex>draggedIndex)targetIndex--;
}

if(targetIndex===draggedIndex){
// Nettoyer
if(indicator&&indicator.parentNode)indicator.parentNode.removeChild(indicator);
if(ghost&&ghost.parentNode)ghost.parentNode.removeChild(ghost);
draggedItem.classList.remove('dragging');
draggedItem=null;
draggedIndex=null;
return;
}

// R√©organiser le tableau
const newSubcats=[...currentCountry.subcategories];
const [moved]=newSubcats.splice(draggedIndex,1);
newSubcats.splice(targetIndex,0,moved);

// Sauvegarder dans Supabase
try{
const {error}=await supabase.from('countries').update({subcategories:newSubcats}).eq('id',currentCountry.id);
if(error)throw error;
currentCountry.subcategories=newSubcats;
showDetail(currentCountry);
}catch(err){
console.error(err);
alert('Erreur lors de la r√©organisation');
}
});

function getDragAfterElement(container,y){
const draggableElements=[...container.querySelectorAll('.subcat-section:not(.dragging)')];

return draggableElements.reduce((closest,child)=>{
const box=child.getBoundingClientRect();
const offset=y-box.top-box.height/2;
if(offset<0&&offset>closest.offset){
return {offset:offset,element:child};
}else{
return closest;
}
},{offset:Number.NEGATIVE_INFINITY}).element;
}
}

function closeDetailPage(){
document.getElementById('detailViewPage').classList.remove('active');
document.getElementById('mainView').classList.remove('hidden');
currentCountry=null;
}

function closeDetailModal(){
document.getElementById('detailModal').classList.remove('show');
currentCountry=null;
}

function openAddCountry(){
currentCountry=null;
sections=[];
document.getElementById('countryModalTitle').textContent='Ajouter un Pays';
document.getElementById('inputName').value='';
document.getElementById('inputFlag').value='';
document.getElementById('inputLink').value='';
renderSections();
document.getElementById('countryModal').classList.add('show');
}

async function editCountry(c){
currentCountry=c;
sections=c.custom_sections?c.custom_sections.map(s=>({...s})):[];
document.getElementById('countryModalTitle').textContent='Modifier '+c.name;
document.getElementById('inputName').value=c.name||'';
document.getElementById('inputFlag').value=c.flag||'';
document.getElementById('inputLink').value=c.link||'';
renderSections();
document.getElementById('countryModal').classList.add('show');
}

function closeCountryModal(){
document.getElementById('countryModal').classList.remove('show');
}

function renderSections(){
const c=document.getElementById('sectionsContainer');
c.innerHTML='';
sections.forEach((s,i)=>{
const div=document.createElement('div');
div.className='section';
const currentColor=s.color||'#a78bfa';
div.innerHTML=`<button class="btn-remove">√ó</button>
<div class="section-row">
<div class="field">
<label>Nom</label>
<input type="text" class="section-name" value="${s.name||''}" placeholder="M√©ta, Paysage...">
</div>
<div class="field-color">
<label>Couleur</label>
<input type="color" class="section-color" value="${currentColor}">
</div>
</div>
<div class="color-presets">
${colorPresets.map(color=>`<div class="color-preset" data-color="${color}" style="background:${color}"></div>`).join('')}
</div>
<label>Valeur</label>
<input type="text" class="section-value" value="${s.value||''}" placeholder="Description...">
<label>Photo (URL optionnelle)</label>
<input type="text" class="section-photo" value="${s.photo||''}" placeholder="https://exemple.com/image.jpg">
<div class="section-photo-preview">${s.photo?`<img src="${s.photo}" onerror="this.style.display='none'">`:''}</div>
<label>Description de la photo</label>
<input type="text" class="section-photo-desc" value="${s.photoDesc||''}" placeholder="Description de l'image...">`;
div.querySelector('.btn-remove').onclick=()=>removeSection(i);
// Mise √† jour de la couleur via input
div.querySelector('.section-color').addEventListener('input',function(){
sections[i].color=this.value;
});
// Mise √† jour de la couleur via presets
div.querySelectorAll('.color-preset').forEach(preset=>{
preset.onclick=function(){
const color=this.dataset.color;
div.querySelector('.section-color').value=color;
sections[i].color=color;
};
});
// Mise √† jour du nom
div.querySelector('.section-name').addEventListener('input',function(){
sections[i].name=this.value;
});
// Mise √† jour de la valeur
div.querySelector('.section-value').addEventListener('input',function(){
sections[i].value=this.value;
});
// Mise √† jour de la photo
div.querySelector('.section-photo').addEventListener('input',function(){
sections[i].photo=this.value;
const preview=div.querySelector('.section-photo-preview');
if(this.value.trim()){
preview.innerHTML=`<img src="${this.value}" onerror="this.style.display='none'">`;
}else{
preview.innerHTML='';
}
});
// Mise √† jour de la description photo
div.querySelector('.section-photo-desc').addEventListener('input',function(){
sections[i].photoDesc=this.value;
});
c.appendChild(div);
});
}

function addSection(){
sections.push({name:'',value:'',color:colorPresets[sections.length%colorPresets.length]});
renderSections();
}

function removeSection(i){
sections.splice(i,1);
renderSections();
}

async function saveCountry(){
const name=document.getElementById('inputName').value.trim();
if(!name){alert('Le nom est obligatoire');return;}

const finalSections=[];
sections.forEach(s=>{
if(s.name&&s.name.trim()){
finalSections.push({
name:s.name.trim(),
value:s.value?s.value.trim():'',
color:s.color||'#a78bfa',
photo:s.photo?s.photo.trim():'',
photoDesc:s.photoDesc?s.photoDesc.trim():''
});
}
});

const data={
continent:CONTINENT,
name,
flag:document.getElementById('inputFlag').value.trim(),
link:document.getElementById('inputLink').value.trim(),
custom_sections:finalSections,
subcategories:currentCountry?currentCountry.subcategories||[]:[]
};

try{
if(currentCountry){
const {error}=await supabase.from('countries').update(data).eq('id',currentCountry.id);
if(error)throw error;
}else{
const {error}=await supabase.from('countries').insert([data]);
if(error)throw error;
}
closeCountryModal();
await loadCountries();
// Si on √©tait dans la vue d√©tail, la rafra√Æchir
if(currentCountry&&document.getElementById('detailViewPage').classList.contains('active')){
const {data:updated}=await supabase.from('countries').select('*').eq('id',currentCountry.id).single();
if(updated)showDetail(updated);
}
}catch(e){
console.error(e);
alert('Erreur: '+e.message);
}
}

async function deleteCountry(c){
if(!confirm(`Supprimer "${c.name}" ?`))return;
try{
await supabase.from('countries').delete().eq('id',c.id);
await loadCountries();
}catch(e){
alert('Erreur');
}
}

function openAddSubcat(){
editSubcatIdx=null;
photos=[];
document.getElementById('subcatModalTitle').textContent='Nouvelle Sous-cat√©gorie';
document.getElementById('inputSubcatName').value='';
renderPhotos();
document.getElementById('subcatModal').classList.add('show');
}

function editSubcat(i){
editSubcatIdx=i;
const s=currentCountry.subcategories[i];
photos=s.photos?[...s.photos]:[];
document.getElementById('subcatModalTitle').textContent='Modifier '+s.name;
document.getElementById('inputSubcatName').value=s.name||'';
renderPhotos();
document.getElementById('subcatModal').classList.add('show');
}

function closeSubcatModal(){
document.getElementById('subcatModal').classList.remove('show');
}

function renderPhotos(){
const c=document.getElementById('photosContainer');
c.innerHTML='';
photos.forEach((p,i)=>{
const div=document.createElement('div');
div.className='section';
div.innerHTML=`<button class="btn-remove" type="button">√ó</button>
<label>URL Image</label>
<input type="text" class="photo-url" data-index="${i}" value="${p.url||''}" placeholder="https://...">
<label>Titre</label>
<input type="text" class="photo-title" data-index="${i}" value="${p.title||''}" placeholder="Description">`;
const urlInput=div.querySelector('.photo-url');
urlInput.addEventListener('input',function(){
photos[i].url=this.value;
updatePhotoPreview();
});
const titleInput=div.querySelector('.photo-title');
titleInput.addEventListener('input',function(){
photos[i].title=this.value;
});
div.querySelector('.btn-remove').onclick=function(e){
e.preventDefault();
removePhoto(i);
};
c.appendChild(div);
if(p.url){
const img=document.createElement('img');
img.src=p.url;
img.style.cssText='width:100%;max-height:150px;object-fit:cover;border-radius:6px;margin-top:10px';
img.onerror=function(){this.style.display='none';};
div.appendChild(img);
}
});
}

function addPhoto(){
photos.push({url:'',title:''});
renderPhotos();
}

function removePhoto(i){
photos.splice(i,1);
renderPhotos();
}

function updatePhotoPreview(){
renderPhotos();
}

async function saveSubcat(){
const name=document.getElementById('inputSubcatName').value.trim();
if(!name){alert('Le nom est obligatoire');return;}

const finalPhotos=[];
photos.forEach(p=>{
if(p.url&&p.url.trim()){
finalPhotos.push({
url:p.url.trim(),
title:p.title?p.title.trim():''
});
}
});

const subcats=currentCountry.subcategories?[...currentCountry.subcategories]:[];
if(editSubcatIdx!==null){
subcats[editSubcatIdx]={name,photos:finalPhotos};
}else{
subcats.push({name,photos:finalPhotos});
}

try{
const {error}=await supabase.from('countries').update({subcategories:subcats}).eq('id',currentCountry.id);
if(error)throw error;
closeSubcatModal();
const {data}=await supabase.from('countries').select('*').eq('id',currentCountry.id).single();
if(data){
currentCountry=data;
showDetail(data);
}
await loadCountries();
}catch(e){
console.error(e);
alert('Erreur: '+e.message);
}
}

async function deleteSubcat(i){
if(!confirm('Supprimer cette sous-cat√©gorie ?'))return;
const subcats=currentCountry.subcategories.filter((_,idx)=>idx!==i);
try{
await supabase.from('countries').update({subcategories:subcats}).eq('id',currentCountry.id);
const {data}=await supabase.from('countries').select('*').eq('id',currentCountry.id).single();
if(data){
currentCountry=data;
showDetail(data);
}
await loadCountries();
}catch(e){
alert('Erreur');
}
}

async function deletePhoto(si,pi){
if(!confirm('Supprimer cette photo ?'))return;
const subcats=[...currentCountry.subcategories];
subcats[si].photos=subcats[si].photos.filter((_,i)=>i!==pi);
try{
await supabase.from('countries').update({subcategories:subcats}).eq('id',currentCountry.id);
const {data}=await supabase.from('countries').select('*').eq('id',currentCountry.id).single();
if(data){
currentCountry=data;
showDetail(data);
}
await loadCountries();
}catch(e){
alert('Erreur');
}
}

function renderCustomContinents(){
const container=document.getElementById('continentDropdown');
// Supprimer les anciens continents personnalis√©s
container.querySelectorAll('.custom-continent').forEach(el=>el.remove());
// Ajouter les nouveaux
const divider=container.querySelector('.continent-divider');
customContinents.forEach(c=>{
const div=document.createElement('div');
div.className='continent-item custom-continent';
div.dataset.continent=c.id;
const logoHtml=c.logo
?`<img src="${c.logo}" class="continent-logo" alt="${c.name}">`
:`<span class="continent-emoji">${c.emoji||'üåê'}</span>`;
div.innerHTML=`${logoHtml}
<span class="continent-name">${c.name}</span>
<button class="btn-del-continent" data-id="${c.id}">√ó</button>`;
div.onclick=function(e){
if(e.target.classList.contains('btn-del-continent'))return;
switchContinent(c.id);
document.getElementById('continentButton').classList.remove('open');
document.getElementById('continentDropdown').classList.remove('show');
};
div.querySelector('.btn-del-continent').onclick=function(e){
e.stopPropagation();
deleteContinent(c.id);
};
container.insertBefore(div,divider);
});
}

function openAddContinent(){
document.getElementById('inputContinentName').value='';
document.getElementById('inputContinentEmoji').value='';
document.getElementById('inputContinentLogo').value='';
document.getElementById('logoPreview').innerHTML='';
document.getElementById('logoTypeEmoji').classList.add('active');
document.getElementById('logoTypeImage').classList.remove('active');
document.getElementById('logoEmojiSection').style.display='block';
document.getElementById('logoImageSection').style.display='none';
document.getElementById('continentModal').classList.add('show');
document.getElementById('continentButton').classList.remove('open');
document.getElementById('continentDropdown').classList.remove('show');
}

function closeContinentModal(){
document.getElementById('continentModal').classList.remove('show');
}

async function saveContinent(){
const name=document.getElementById('inputContinentName').value.trim();
if(!name){alert('Le nom est obligatoire');return;}
const isImageMode=document.getElementById('logoTypeImage').classList.contains('active');
const emoji=document.getElementById('inputContinentEmoji').value.trim()||'üåê';
const logo=document.getElementById('inputContinentLogo').value.trim();
const id=name.toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'');
if(baseContinentNames[id]||customContinents.find(c=>c.id===id)){
alert('Cette cat√©gorie existe d√©j√†');return;
}
const newContinent={id,name};
if(isImageMode&&logo){
newContinent.logo=logo;
}else{
newContinent.emoji=emoji;
}
try{
const {error}=await supabase.from('custom_continents').insert([newContinent]);
if(error)throw error;
customContinents.push(newContinent);
renderCustomContinents();
closeContinentModal();
switchContinent(id);
}catch(e){
console.error(e);
alert('Erreur lors de la sauvegarde: '+e.message);
}
}

async function deleteContinent(id){
if(!confirm('Supprimer cette cat√©gorie ?'))return;
try{
const {error}=await supabase.from('custom_continents').delete().eq('id',id);
if(error)throw error;
customContinents=customContinents.filter(c=>c.id!==id);
renderCustomContinents();
if(CONTINENT===id){
switchContinent('europe');
}
}catch(e){
console.error(e);
alert('Erreur lors de la suppression: '+e.message);
}
}

init();
})();
</script>
</body>
</html>
